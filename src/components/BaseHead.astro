---
import "normalize.css";
import "~/styles/fonts.css";
import "~/styles/global.css";
import "~/styles/typography-optimized.css";

interface Props {
  title: string;
  description: string;
  image?: string;
  cover?: string;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { title, description, image = "/img/avatar.png", cover } = Astro.props;

// Optimize meta description (150-160 characters for best SEO)
const optimizedDescription = description.length > 160 
  ? description.substring(0, 157) + "..." 
  : description;

// Use cover image if available, otherwise default image
const socialImage = cover || image;
const fullImageUrl = new URL(socialImage, Astro.url);
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- Fonts are loaded via @fontsource packages -->
<link
  rel="apple-touch-icon"
  sizes="180x180"
  href="/favicon_io/apple-touch-icon.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="32x32"
  href="/favicon_io/favicon-32x32.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="16x16"
  href="/favicon_io/favicon-16x16.png"
/>
<link rel="manifest" href="/favicon_io/site.webmanifest" />
<link rel="icon" href="/favicon.ico" sizes="any" />
<link
  rel="icon"
  type="image/png"
  sizes="192x192"
  href="/favicon_io/android-chrome-192x192.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="512x512"
  href="/favicon_io/android-chrome-512x512.png"
/>
<meta name="theme-color" content="#0a0a0c" />
<meta name="generator" content={Astro.generator} />
<!-- Dark theme only - apply immediately -->
<script is:inline>
  (function() {
    document.addEventListener('DOMContentLoaded', function() {
      document.body.setAttribute('data-theme', 'dark');
    });
  })();
</script>

<!-- Privacy-first self-hosted analytics â€” no cookies, no IP stored -->
<script is:inline>
(function(){
  if(navigator.doNotTrack==="1"||navigator.webdriver)return;
  var id=Math.random().toString(36).slice(2,10);
  var ref=document.referrer;
  var isUnique=!ref||new URL(ref).hostname!==location.hostname;
  var params=new URLSearchParams(location.search);
  var utm={s:params.get("utm_source"),m:params.get("utm_medium"),c:params.get("utm_campaign"),t:params.get("utm_content")};
  if(utm.s||utm.m||utm.c||utm.t){
    params.delete("utm_source");params.delete("utm_medium");params.delete("utm_campaign");params.delete("utm_content");
    var qs=params.toString();
    history.replaceState(null,"",location.pathname+(qs?"?"+qs:"")+location.hash);
  }
  var data={type:"pageview",page_id:id,hostname:location.hostname,pathname:location.pathname,referrer:ref||null,
    utm_source:utm.s,utm_medium:utm.m,utm_campaign:utm.c,utm_content:utm.t,is_unique:isUnique,
    screen_width:screen.width,screen_height:screen.height,viewport_width:innerWidth,viewport_height:innerHeight,
    language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone};
  fetch("/api/collect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data),keepalive:true}).catch(function(){});
  var start=Date.now(),maxScroll=0,hidden=false;
  function onScroll(){var h=document.documentElement.scrollHeight-innerHeight;if(h>0){var pct=Math.round(scrollY/h*100/5)*5;if(pct>maxScroll)maxScroll=pct;}}
  window.addEventListener("scroll",onScroll,{passive:true});
  document.addEventListener("visibilitychange",function(){
    if(document.visibilityState==="hidden"&&!hidden){
      hidden=true;
      var t=Math.round((Date.now()-start)/1000);
      navigator.sendBeacon("/api/collect",JSON.stringify({type:"beacon",page_id:id,time_on_page:t,scroll_depth:maxScroll}));
    }
  });
})();
</script>


<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={optimizedDescription} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={optimizedDescription} />
<meta property="og:image" content={fullImageUrl} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:alt" content={title} />
<meta property="og:site_name" content="Valerio Narcisi" />

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content={Astro.url} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={optimizedDescription} />
<meta name="twitter:image" content={fullImageUrl} />
<meta name="twitter:image:alt" content={title} />
<meta name="twitter:creator" content="@valerionarcisi" />
<meta name="twitter:site" content="@valerionarcisi" />

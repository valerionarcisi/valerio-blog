---
import { getCollection } from "astro:content";
import Title from "~/components/Title.astro";
import Card from "~/components/Card.astro";
import { getSlugFromId, getLangFromId, useTranslations } from "~/i18n/utils";
import type { Lang } from "~/i18n/ui";

interface Props {
  currentSlug: string;
  currentTags: string[];
  maxPosts?: number;
  lang?: string;
}

const { currentSlug, currentTags, maxPosts = 6, lang = "it" } = Astro.props;
const t = useTranslations(lang as Lang);

function calculateSimilarity(postTags: string[], currentTags: string[]): number {
  const commonTags = postTags.filter(tag => currentTags.includes(tag));
  return commonTags.length;
}

const allPosts = await getCollection("blog");
const relatedPosts = allPosts
  .filter(post => getLangFromId(post.id) === lang)
  .filter(post => getSlugFromId(post.id) !== currentSlug)
  .map(post => ({
    ...post.data,
    slug: getSlugFromId(post.id),
    coverImage: post.data.coverImage,
    similarity: calculateSimilarity(post.data.tags || [], currentTags),
  }))
  .filter(post => post.similarity > 0)
  .sort((a, b) => {
    if (b.similarity !== a.similarity) return b.similarity - a.similarity;
    return new Date(b.date).getTime() - new Date(a.date).getTime();
  })
  .slice(0, maxPosts);
---

{relatedPosts.length > 0 && (
  <section class="related-posts">
    <Title title={t("blog.relatedPosts")} />
    <div class="related-posts-grid">
      {relatedPosts.map((post) => (
        <Card {...post} slug={post.slug} lang={lang} />
      ))}
    </div>
  </section>
)}

<style>
  .related-posts {
    max-width: 85%;
    margin: 0 auto;
    padding: var(--space-large) 0;
    border-top: 2px solid var(--color-tertiary);
  }

  .related-posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-medium);
    margin-top: var(--space-large);
  }

  .related-posts-grid :global(.Card) {
    max-width: 100%;
    margin: 0;
    padding: 0;
    grid-template-columns: 1fr;
    gap: var(--space-small);
  }

  .related-posts-grid :global(.Card .content) {
    padding: 0 6rem;
  }

  .related-posts-grid :global(.Card h3) {
    font-size: var(--fontSize-medium);
    margin-bottom: var(--space-small);
  }

  .related-posts-grid :global(.Card .description) {
    font-size: var(--fontSize-very-small);
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media screen and (max-width: 768px) {
    .related-posts {
      max-width: 85%;
    }

    .related-posts-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

---
import fetchHyPosts from "~/services/post";
import Title from "~/components/Title.astro";
import Card from "~/components/Card.astro";

interface Props {
  currentSlug: string;
  currentTags: string[];
  maxPosts?: number;
}

const { currentSlug, currentTags, maxPosts = 6 } = Astro.props;

// Function to calculate tag similarity score
function calculateSimilarity(postTags: string[], currentTags: string[]): number {
  const commonTags = postTags.filter(tag => currentTags.includes(tag));
  return commonTags.length;
}

const allPosts = await fetchHyPosts(100);
const relatedPosts = allPosts
  ?.filter(post => post.slug !== currentSlug) // Exclude current post
  .map(post => ({
    ...post,
    similarity: calculateSimilarity(post.tags || [], currentTags)
  }))
  .filter(post => post.similarity > 0) // Only posts with at least 1 common tag
  .sort((a, b) => {
    // Sort by similarity first, then by date (newest first)
    if (b.similarity !== a.similarity) {
      return b.similarity - a.similarity;
    }
    return new Date(b.date).getTime() - new Date(a.date).getTime();
  })
  .slice(0, maxPosts) || [];
---

{relatedPosts.length > 0 && (
  <section class="related-posts">
    <Title title="Related Posts" />
    <div class="related-posts-grid">
      {relatedPosts.map((post) => (
        <Card {...post} slug={post.slug} />
      ))}
    </div>
  </section>
)}

<style>
  .related-posts {
    max-width: 85%;
    margin: 0 auto;
    padding: var(--space-large) 0;
    border-top: 2px solid var(--color-tertiary);
  }

  .related-posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-medium);
    margin-top: var(--space-large);
  }

  /* Override Card styles for related posts grid */
  .related-posts-grid :global(.Card) {
    max-width: 100%;
    margin: 0;
    padding: 0;
    grid-template-columns: 1fr;
    gap: var(--space-small);
  }

  .related-posts-grid :global(.Card .content) {
    padding: 0 6rem;
  }

  .related-posts-grid :global(.Card h3) {
    font-size: var(--fontSize-medium);
    margin-bottom: var(--space-small);
  }

  .related-posts-grid :global(.Card .description) {
    font-size: var(--fontSize-very-small);
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media screen and (max-width: 768px) {
    .related-posts {
      max-width: 85%;
    }

    .related-posts-grid {
      grid-template-columns: 1fr;
    }
  }

</style>
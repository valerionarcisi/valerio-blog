---
import BaseHead from "~/components/BaseHead.astro";
import Header from "~/components/Header.astro";
import Footer from "~/components/Footer.astro";
import FormattedDate from "~/components/FormattedDate.astro";
import Tag from "~/components/Tag.astro";
import Title from "~/components/Title.astro";
import StructuredData from "~/components/StructuredData.astro";
import ReadingTime from "~/components/ReadingTime.astro";
import RelatedPosts from "~/components/RelatedPosts.astro";
import { SITE_TITLE } from "~/consts";
import "./BlogPost.css";

interface Props {
  title: string;
  extract: string;
  date: string;
  coverImage: string;
  tags: string[];
  slug: string;
  lang?: string;
  coverAuthorName?: string | null;
  coverAuthorLink?: string | null;
  coverDescription?: string | null;
}

const {
  title,
  extract,
  date,
  coverImage,
  lang = "it",
  tags,
  coverAuthorName,
  coverAuthorLink,
  coverDescription,
  slug,
} = Astro.props;

const content = await Astro.slots.render("default");
---

<html lang={lang}>
  <head>
    <BaseHead
      title={`${title} | ${SITE_TITLE}`}
      description={extract}
      cover={coverImage}
    />
    <StructuredData
      type="article"
      title={title}
      description={extract}
      url={Astro.url.href}
      image={coverImage}
      datePublished={date}
      tags={tags}
    />
  </head>

  <body>
    <Header />
    <main>
      <article class="BlogPost">
        <Title title={title} />
        <div class="info">
          <div class="cover-image">
            {coverImage && <img src={coverImage} alt={title} />}
          </div>
          <div class="metadata">
            <div class="tags">
              {tags.map((tag: string) => <Tag tag={tag} lang={lang} />)}
            </div>
            <div class="date">
              Posted on <FormattedDate date={new Date(date)} />
            </div>
            <ReadingTime content={content} />
          </div>
        </div>
        {
          coverAuthorName && (
            <div class="author">
              Cover by
              <a target="_blank" href={coverAuthorLink || "#"}>
                {coverAuthorName}
              </a>
              {coverDescription && (
                <div class="description">{coverDescription}</div>
              )}
            </div>
          )
        }
        <div class="prose">
          <slot />
        </div>

        <RelatedPosts currentSlug={slug} currentTags={tags} lang={lang} />
      </article>
    </main>
    <Footer />
    <script is:inline>
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.prose pre').forEach(function(pre) {
          var btn = document.createElement('button');
          btn.className = 'copy-btn';
          btn.textContent = 'Copy';
          btn.addEventListener('click', function() {
            var code = pre.querySelector('code');
            if (code) {
              navigator.clipboard.writeText(code.textContent || '');
              btn.textContent = 'âœ“';
              setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
            }
          });
          pre.appendChild(btn);
        });
      });
    </script>
  </body>
</html>

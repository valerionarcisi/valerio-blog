---
import AstroLayout from "../layouts/layout.astro";
import Home from "../components/Home/Home";
import { getAndParseHyGraphAbstractPost } from "../services/hygraph";
import type { ExitTAbstractPost } from "../services/hygraph";
import { Effect, Match } from "effect";
import { getAndParseRecentTrack } from "../services/audioscrobbler";
import { program } from "../services/letterboxd";

const music = await Effect.runPromiseExit(getAndParseRecentTrack());
const movie = await Effect.runPromiseExit(program);

const posts = (await Effect.runPromiseExit(
  getAndParseHyGraphAbstractPost(`{
      posts(orderBy: publishedAt_DESC, last: 5) {
        id,
        title,
        slug,
        publishedAt,
        tags,
        extract
        coverImage {
          id,
          url,
          fileName,
        }
      }
    }
  `)
)) as ExitTAbstractPost;

const postMatch = Match.typeTags<ExitTAbstractPost>()({
  Success: ({ value }) => (value.map((post) => ({
    params: { slug: post.slug },
  }))),
  Failure: () => ({
    params: { slug: "404" },
  }),
});

export const getStaticPaths = () => {
  return postMatch(posts);
}
---

<AstroLayout
  seo={{
    title: `Home | Valerio Narcisi - web developer, director and screenwriter`,
    description:
      "Valerio Narcisi web developer, director and screenwriter. This is my personal blog where I post my thoughts on technology, movies books and other things.",
    name: `Home | Valerio Narcisi - web developer, director and screenwriter`,
    type: "website",
  }}
>
  <Home posts={posts} lastTrack={music} lastMovie={movie} />
</AstroLayout>

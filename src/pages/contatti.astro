---
import BaseHead from "~/components/BaseHead.astro";
import Header from "~/components/Header.astro";
import Footer from "~/components/Footer.astro";
import { SITE_TITLE } from "~/consts";
import Title from "~/components/Title.astro";
import "~/layouts/BlogPost.css";
import "~/components/ContactForm.css";
---

<!doctype html>
<html lang="it">
  <head>
    <BaseHead
      title={`Contatti | ${SITE_TITLE}`}
      description="Scrivimi un messaggio, ti rispondo il prima possibile."
    />
  </head>
  <body>
    <Header />
    <main class="BlogPost">
      <Title title="Contatti" />
      <section class="prose">
        <p>Hai una domanda, una proposta o vuoi semplicemente salutare? Compila il form e ti rispondo il prima possibile.</p>

        <form class="contact-form" id="contact-form">
          <label>
            Nome
            <input type="text" name="name" required maxlength="100" autocomplete="name" />
          </label>
          <label>
            Email
            <input type="email" name="email" required maxlength="254" autocomplete="email" />
          </label>
          <label>
            Messaggio
            <textarea name="message" required maxlength="5000"></textarea>
          </label>
          <div class="hp-field" aria-hidden="true">
            <input type="text" name="website" tabindex="-1" autocomplete="off" />
          </div>
          <button type="submit">Invia</button>
        </form>
        <div id="form-result" aria-live="polite"></div>
      </section>
    </main>
    <Footer />

    <script is:inline>
      (function() {
        var form = document.getElementById("contact-form");
        var result = document.getElementById("form-result");

        function showMsg(cls, text) {
          result.textContent = "";
          var div = document.createElement("div");
          div.className = "form-msg " + cls;
          div.textContent = text;
          result.appendChild(div);
        }

        form.addEventListener("submit", function(e) {
          e.preventDefault();
          var btn = form.querySelector("button");
          btn.disabled = true;
          btn.textContent = "Invio in corso...";
          result.textContent = "";

          var data = {
            name: form.name.value.trim(),
            email: form.email.value.trim(),
            message: form.message.value.trim(),
            website: form.website.value
          };

          fetch("/api/contact", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          })
          .then(function(r) {
            if (r.ok) {
              showMsg("ok", "Messaggio inviato! Ti rispondo il prima possibile.");
              form.reset();
            } else {
              return r.json().then(function(d) { throw new Error(d.error || "Errore"); });
            }
          })
          .catch(function(err) {
            showMsg("err", "Errore: " + err.message);
          })
          .finally(function() {
            btn.disabled = false;
            btn.textContent = "Invia";
          });
        });
      })();
    </script>
  </body>
</html>

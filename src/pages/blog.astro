---
import AstroLayout from "../layouts/layout.astro";
import BlogComponent from "../components/Blog/Blog";
import {
  getAndParseHyGraphAbstractPost,
  type ExitTAbstractPost,
} from "../services/hygraph";
import { Effect, Match } from "effect";

const posts = (await Effect.runPromiseExit(
  getAndParseHyGraphAbstractPost(`{
      posts(orderBy: publishedAt_DESC) {
        id,
        title,
        slug,
        publishedAt,
        tags,
        extract
        createdAt
        coverImage {
          id,
          url,
          fileName,
        }
      }
    }
  `)
)) as ExitTAbstractPost;

const postMatch = Match.typeTags<ExitTAbstractPost>()({
  Success: ({ value }) =>
    value.map((post) => ({
      params: { slug: post.slug },
    })),
  Failure: () => ({
    params: { slug: "404" },
  }),
});

export const getStaticPaths = () => {
  return postMatch(posts);
};
---

<AstroLayout
  seo={{
    title: `Blog | Valerio Narcisi - web developer, director and screenwriter`,
    description:
      "Blog page of Valerio Narcisi web developer, director and screenwriter.",
    name: `Blog | Valerio Narcisi - Blog`,
    type: "website",
  }}
>
  <BlogComponent posts={posts} title="Blog" />
</AstroLayout>
